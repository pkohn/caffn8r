<!DOCTYPE html>
<html>
<title>Caffn8r</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="animate.css">
<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
<style type="text/css">
text:hover {
    cursor: pointer;
}

.title-text {
    color: white;
    text-shadow: 1px 1px 1px rgba(0, 0, 0, .5);
}
</style>

<body>
    <!-- Header -->
    <header style="background-image: url('background2.jpg'); background-size: 100% auto">
    <link rel="icon" href="coffee-bean.png"/>
   
        <script src="https://code.jquery.com/jquery-2.2.4.js"></script>
       
       <!--  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" /> -->
        <div class="pk-center">
            <h1 class="pk-xxxlarge pk-animate-right title-text">CAFFN8R</h1>
            <h6 class="pk-animate-left title-text"><b><i>Find your local buzz</h6></b>
            </i>
            <div class="pk-padding-32">
                <div class="title-text">
                    <form id="location-search">
                        <label>
                            Location
                            <input type="text" placeholder="Where are you?" name="location">
                        </label>
                        <button>Search</button>
                    </form>
                </div>
                <pre></pre>
                <script>
                $('#location-search').on('submit', function(e) {
                    e.preventDefault();

                    var location = $(this).find('input').val();

                    $.ajax({
                        url: 'http://nominatim.openstreetmap.org/search/{{term}}?format=json&addressdetails=1'.replace('{{term}}', location)
                    }).then(function(res) {

                        searchYelp(res[0].lat, res[0].lon);
                        map.panTo(new L.LatLng(res[0].lat, res[0].lon), 13);
                        $("#wordcloud").empty();
                        $("#business-info").empty();
                        // $("#wordcloud").load(function() {
                            $("#facomments").addClass("fa-spin fa-3x fa-fw");
                          // });
                        //spin cloud icon while loading
                        //change map when you click on a coffee shop (target.nodeName?) and delete prev one
                        //resize wordcloud so it is 100% when you resize page
                        //how to view on raw git?
                        //favicon icon?
                    })

                });
                </script>
            </div>
        </div>
    </header>
    <div class="pk-row-padding pk-center pk-margin-top">
        <div class="pk-third">
            <div class="pk-card-2 pk-padding-top" style="min-height:460px">
                <h4><b>your hood</h4></b>
                <i class="fa fa-map-marker" style="font-size:100px"></i>

                <head>
                    <style>
                    #map {
                        width: 500px;
                        height: 400px;
                    }
                    </style>
                </head>
                <div id="thisLeaflet"></div>
            </div>
        </div>
        <div class="pk-third">
            <div class="pk-card-2 pk-padding-top" style="min-height:460px">
                <h4><b>what's buzzin?</h4></b>
                <i id = facomments class="fa fa-comments-o" style="font-size:100px"></i><br>
                <!-- <span class="sr-only">A coffee cloud is forming...</span> -->
                <svg id="wordcloud"></svg>
            </div>
        </div>
        <div class="pk-third">
            <div class="pk-card-2 pk-padding-top" style="min-height:460px">
                <h4><b>caffn8tion stations nearby</h4></b>
                <h4></h4>
                <i class="fa fa-coffee" style="font-size:100px"></i>
                <div class="businesses"></div>
                <script type="text/html" id="business-template">
                    <div class="business">
                        <li id="business-{{id}}" class="business-list-item"><a href="{{url}}" class="business-link" data-id="{{id}}">{{name}}</a> ({{review_count}} reviews)</li>
                    </div>
                </script>
            </div>
        </div>
    </div>
    <div id="business-info"></div>
    <script type="text/html" id="business-info-template">
        <header class="pk-container pk-blue-grey">
            <h2>Caffn8tion Station Deets</h2>
        </header>
        <div class="pk-padding pk-white">
            <h2>{{name}} ({{location.neighborhoods}}, {{location.city}})</h2>
            <div class="business">
                <div>
                    <img src="{{image_url}}" alt="">
                </div>
                <p>Located @ {{location.address}} (<i class="fa fa-phone" style="font-size:15px"></i> {{phone}})</p>
                <p>{{rating}} stars: "{{snippet_text}}"</p>
            </div>
    </script>
    </div>
    
    <!-- Footer -->
    <footer class="pk-container pk-blue-grey">

        <p class="pk-opacity">Caffn8ed in Seattle by pkohn, 2016 </p>
    </footer>
    <script src="https://cdn.rawgit.com/bettiolo/oauth-signature-js/master/dist/oauth-signature.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>

    <script>
    // L.mapbox.accessToken = 'pk.eyJ1IjoicGtvaG4iLCJhIjoiY2lvcTMxeXpxMDAwaHVlbTBrY3J5dDduYiJ9.SIavQJ1I80cZkT1hb_o-og';
    //     var mymap = L.mapbox.map('thisLeaflet', 'mapbox.streets');
    //     L.control.locate().addTo(mymap);
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script type="text/javascript" src="d3cloud.js"></script>
    <!-- <script src ="https://rawgit.com/jasondavies/d3-cloud/master/build/d3.layout.cloud.js"></script> -->
    <script type="text/javascript" src="cloud.js"></script>
    <script type="text/javascript" src="main.js"></script>
    <script>
    var businessWords;
    var businessInfo;

    // PUT YOUR KEYS HERE
    var keys = {
        consumer_key: '1sQO6VG_mdXNkedsMVeMKw',
        consumer_secret: 'Blj3AM-0SIJirxNl_md4JsBMFDE',
        token: '-FwwA5NLdb7TSEKBDXSglrjDCfHSS-EN',
        token_secret: 'JfGBdnqOKTF_OiZrxeWkWr9JqWU'
    };


    navigator.geolocation.getCurrentPosition(function(position) {

        console.log(position);

        searchYelp(position.coords.latitude, position.coords.longitude);

    }, function() {
        searchYelp();
    });


    function searchYelp(lat, lng) {
        searchHelper().catch(function(err) {
            console.log(err.stack);
            searchYelp();
        });

        function searchHelper() {
            // return search('coffee', 47.609895, -122.33025)
            return search('coffee', lat || 47.609895, lng || -122.33025)
                .then(res => {
                    const template = document.getElementById('business-template').innerHTML;
                    const container = document.getElementsByClassName('businesses')[0];

                    var max = 0;

                    businessWords = {};
                    businessInfo = {};

                    // document.getElementById('numBiz').textContent = res.businesses.length;

                    // Get all the words and counts of each word
                    const wordMap = res.businesses.reduce((acc, business) => {

                        businessInfo[business.id] = business;

                        var snippetWords = business.snippet_text.toLowerCase().replace(/[^\w ]/g, '').split(' ');

                        snippetWords.forEach(word => {
                            if (stopWords[word]) return;

                            businessWords[word] = (businessWords[word] || {});
                            businessWords[word][business.id] = true;

                            acc[word] = (acc[word] || 0) + 1;

                        });

                        return acc;
                    }, {});

                    // Find the most common word
                    Object.keys(wordMap).forEach(word => {
                        max = Math.max(wordMap[word], max);
                    });

                    console.log(max, wordMap);

                    const words = Object.keys(wordMap).map(word => {
                        return {
                            text: word,
                            size: 10 + 100 * (wordMap[word] / max)
                        }
                    });

                    Object.keys(businessWords).forEach(function(word) {
                        businessWords[word] = Object.keys(businessWords[word]);
                    });

                    drawCloud(words);
                    $("#facomments").removeClass("fa-spin fa-3x fa-fw");

                    const items = res.businesses.map(business => compile(template, business));


                    container.innerHTML = items
                        .reduce((acc, n, i) => {
                            acc[i % 1] = (acc[i % 1] || []).concat(n);
                            return acc;
                        }, [])
                        .map(col => `<div class="col">${col.join('')}</div>`)
                        .join('');
                });
        }
    }

    document.body.addEventListener('click', function(event) {
        
        var target = event.target;
        
        if (target.nodeName === 'text') {
            
             $("#business-info").empty();

            const ids = businessWords[event.target.textContent];

            [].slice.call(document.getElementsByClassName('business-list-item')).forEach(function(item) {
                item.style.fontWeight = 300;
            });

            const businesses = ids.map(function(id) {

                var listElement = document.getElementById('business-' + id);

                listElement.style.fontWeight = 900;

                return businessInfo[id];

            });

            console.log(businesses);

            map.removeLayer(businessLayer);

            var points = businesses.map(function(business) {
                return [
                    business.location.coordinate.latitude,
                    business.location.coordinate.longitude
                ];
            });

            
            var coffeeIcon = L.icon({ iconUrl: 'coffee-bean.png', shadowUrl: 'coffee-bean.png', iconSize: [75, 75] }); 


            var markers = points.map(function(coords, i) {
                
                    if(businesses[i].location.cross_streets === undefined || businesses[i].location.neighborhoods === undefined){
                      return L.marker(coords, {icon: coffeeIcon})
                      .bindPopup("<b>Hello!</b><br>My name is " + businesses[i].name + '.');

                    } else return L.marker(coords, {icon: coffeeIcon}).bindPopup("<b>Hello!</b><br>My name is " + businesses[i].name + '. I\'m located at ' + businesses[i].location.cross_streets + ' in '+ businesses[i].location.neighborhoods + '.');
          
            });

            businessLayer = L.layerGroup(markers)
                .addTo(map);



        } else if (target.classList.contains('business-link')) {
            
            event.preventDefault();
            map.removeLayer(businessLayer);

            var business = businessInfo[target.dataset.id];
            
            console.log(business);

            var points = [[
                    business.location.coordinate.latitude,
                    business.location.coordinate.longitude
                ]];

            console.log(points);
           
            var coffeeIcon = L.icon({ iconUrl: 'coffee-bean.png', shadowUrl: 'coffee-bean.png', iconSize: [75, 75] }); 

            var marker = points.map(function(coords, i) {
                if(business.location.cross_streets === undefined || business.location.neighborhoods === undefined){
                      return L.marker(coords, {icon: coffeeIcon})
                      .bindPopup("<b>Hello!</b><br>My name is " + business.name + '.');

                    } else return L.marker(coords, {icon: coffeeIcon}).bindPopup("<b>Hello!</b><br>My name is " + business.name + '. I\'m located at ' + business.location.cross_streets + ' in '+ business.location.neighborhoods + '.');
            });

            businessLayer = L.layerGroup(marker).addTo(map);

            const template = document.getElementById('business-info-template').innerHTML;
            const container = document.getElementById('business-info');

            container.innerHTML = compile(template, business);

        }
    });


    function compile(template, obj) {
        return template.replace(/\{\{([^\}]+)\}\}/g, (match, capture, index) => {
            const path = capture.split('.');
            const replacement = path.reduce((acc, prop) => {
                if (acc) {
                    return acc[prop];
                }
            }, obj);
            return replacement || '';
        });
    }


    function search(term, lat, lng) {

        return new Promise(function(resolve, reject) {

            function randomString(length, chars) {
                var result = '';
                for (var i = length; i > 0; --i) result += chars[Math.round(Math.random() * (chars.length - 1))];
                return result;
            }

            const callback = 'callback_' + randomString(10, '0123456789');

            var method = 'GET';
            var url = 'http://api.yelp.com/v2/search';
            var params = {
                callback: callback,
                ll: lat + ',' + lng,
                oauth_consumer_key: keys.consumer_key, //Consumer Key
                oauth_token: keys.token, //Token
                oauth_signature_method: "HMAC-SHA1",
                oauth_timestamp: new Date().getTime(),
                oauth_nonce: randomString(32, '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'),
                term: term
            };

            var consumerSecret = keys.consumer_secret; //Consumer Secret
            var tokenSecret = keys.token_secret; //Token Secret
            var signature = oauthSignature.generate(method, url, params, consumerSecret, tokenSecret, {
                encodeSignature: false
            });

            params['oauth_signature'] = signature.replace(/ /g, '%20').replace(/\+/g, '%2B');

            var fullUrl = url + '?' + Object.keys(params).map(n => `${n}=${params[n]}`).join('&');

            var script = document.createElement('script');

            window[callback] = function(data) {
                script.remove();
                delete window[callback];
                resolve(data);
            };

            var failureTimeout = setTimeout(function() {
                reject(new Error('Failed to load'));
            }, 1000 * 2);

            script.onload = function() {
                console.log('onload called');
                if (!this.readyState || this.readyState == "loaded" || this.readyState == "complete") {
                    console.log('loaded!');
                    clearTimeout(failureTimeout);
                } else {
                    reject(new Error('failed to load'));
                }
            };

            script.src = fullUrl;

            document.body.appendChild(script);

        });
    }
    </script>
</body>

</html>
